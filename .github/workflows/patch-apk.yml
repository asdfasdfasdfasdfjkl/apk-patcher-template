name: Build Patched APK

on:
  workflow_dispatch:
    inputs:
      buildId:
        description: 'Build ID'
        required: true
        type: string
      appName:
        description: 'App Name'
        required: true
        type: string
      websiteUrl:
        description: 'Website URL'
        required: true
        type: string
      iconBase64:
        description: 'App Icon (Base64)'
        required: false
        type: string
      contactEmail:
        description: 'Contact Email'
        required: true
        type: string

env:
  BUILD_ID: ${{ github.event.inputs.buildId }}
  APP_NAME: ${{ github.event.inputs.appName }}
  WEBSITE_URL: ${{ github.event.inputs.websiteUrl }}
  ICON_BASE64: ${{ github.event.inputs.iconBase64 }}
  CONTACT_EMAIL: ${{ github.event.inputs.contactEmail }}
  
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
  API_BASE_URL: ${{ secrets.API_BASE_URL }}
  BUILD_SECRET: ${{ secrets.BUILD_SECRET }}

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install apktool
      run: |
        wget -q https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
        wget -q https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar
        mv apktool_2.9.3.jar apktool.jar
        chmod +x apktool apktool.jar
        sudo mv apktool* /usr/local/bin/
    
    - name: Install sharp
      run: npm install -g sharp-cli
    
    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y zipalign
    
    - name: Create icon from base64
      if: env.ICON_BASE64 != ''
      run: |
        echo "$ICON_BASE64" | base64 -d > icon.png
        npx sharp-cli icon.png -o icon.webp
    
    - name: Update build status - Started
      run: |
        curl -X POST "$API_BASE_URL/api/build/status-update" \
          -H "Content-Type: application/json" \
          -H "X-Build-Secret: $BUILD_SECRET" \
          -d '{
            "buildId": "'$BUILD_ID'",
            "status": "in_progress",
            "message": "Decoding APK..."
          }'
    
    - name: Decode APK
      run: |
        apktool d base.apk -f -o decoded
    
    - name: Update build status - Patching
      run: |
        curl -X POST "$API_BASE_URL/api/build/status-update" \
          -H "Content-Type: application/json" \
          -H "X-Build-Secret: $BUILD_SECRET" \
          -d '{
            "buildId": "'$BUILD_ID'",
            "status": "in_progress",
            "message": "Patching BuildConfig with BUILD_ID..."
          }'
    
    - name: Patch BUILD_ID
      run: |
        find decoded -name "BuildConfig.smali" -exec sed -i "s/const-string v0, \"[0-9]*\"[[:space:]]*sput-object v0, Lcom\/qavola\/universalwebview\/BuildConfig;->BUILD_ID:Ljava\/lang\/String;/const-string v0, \"$BUILD_ID\"\n    sput-object v0, Lcom\/qavola\/universalwebview\/BuildConfig;->BUILD_ID:Ljava\/lang\/String;/g" {} \;
    
    - name: Update build status - Changing App Name
      run: |
        curl -X POST "$API_BASE_URL/api/build/status-update" \
          -H "Content-Type: application/json" \
          -H "X-Build-Secret: $BUILD_SECRET" \
          -d '{
            "buildId": "'$BUILD_ID'",
            "status": "in_progress",
            "message": "Changing app name to: '$APP_NAME'..."
          }'
    
    - name: Change App Name
      run: |
        sed -i "s|<string name=\"app_name\">.*</string>|<string name=\"app_name\">$APP_NAME</string>|g" decoded/res/values/strings.xml
    
    - name: Update build status - Replacing Icons
      if: env.ICON_BASE64 != ''
      run: |
        curl -X POST "$API_BASE_URL/api/build/status-update" \
          -H "Content-Type: application/json" \
          -H "X-Build-Secret: $BUILD_SECRET" \
          -d '{
            "buildId": "'$BUILD_ID'",
            "status": "in_progress",
            "message": "Replacing app icons..."
          }'
    
    - name: Replace Icons
      if: env.ICON_BASE64 != ''
      run: |
        cat > replace-icons.js << 'EOF'
        const fs = require('fs');
        const { execSync } = require('child_process');
        
        const ICON_PATH = 'icon.webp';
        const BASE_PATH = 'decoded/res';
        
        const ICON_SIZES = {
          'mipmap-xxxhdpi': 192,
          'mipmap-xxhdpi': 144,
          'mipmap-xhdpi': 96,
          'mipmap-hdpi': 72,
          'mipmap-mdpi': 48,
          'mipmap': 48,
          'mipmap-ldpi': 36,
        };
        
        if (!fs.existsSync(ICON_PATH)) {
          console.log('No icon file found, skipping...');
          process.exit(0);
        }
        
        const folders = fs.readdirSync(BASE_PATH).filter(f => 
          f.startsWith('mipmap') || f.startsWith('drawable')
        );
        
        folders.forEach(folder => {
          const folderPath = `${BASE_PATH}/${folder}`;
          if (!fs.existsSync(folderPath)) return;
          
          let targetSize = ICON_SIZES[folder] || 48;
          
          const files = fs.readdirSync(folderPath);
          
          files.forEach(file => {
            if ((file.includes('ic_launcher') || file.includes('icon')) && 
                (file.endsWith('.png') || file.endsWith('.webp'))) {
              
              const fullPath = `${folderPath}/${file}`;
              const ext = file.split('.').pop();
              
              console.log(`Replacing: ${folder}/${file} (${targetSize}x${targetSize}px)`);
              
              try {
                execSync(`npx sharp-cli ${ICON_PATH} --resize ${targetSize} ${targetSize} --output ${fullPath}.tmp --format ${ext}`, { stdio: 'inherit' });
                fs.renameSync(`${fullPath}.tmp`, fullPath);
              } catch (err) {
                console.error(`Error processing ${fullPath}:`, err.message);
              }
            }
          });
        });
        
        // Fix AndroidManifest.xml
        const manifestPath = 'decoded/AndroidManifest.xml';
        if (fs.existsSync(manifestPath)) {
          let manifest = fs.readFileSync(manifestPath, 'utf8');
          
          if (!manifest.includes('android:icon=')) {
            manifest = manifest.replace('<application', '<application android:icon="@mipmap/ic_launcher"');
          }
          
          if (!manifest.includes('android:roundIcon=')) {
            manifest = manifest.replace('<application', '<application android:roundIcon="@mipmap/ic_launcher_round"');
          }
          
          fs.writeFileSync(manifestPath, manifest);
        }
        
        console.log('âœ… Icon replacement completed');
        EOF
        
        node replace-icons.js
    
    - name: Update build status - Rebuilding
      run: |
        curl -X POST "$API_BASE_URL/api/build/status-update" \
          -H "Content-Type: application/json" \
          -H "X-Build-Secret: $BUILD_SECRET" \
          -d '{
            "buildId": "'$BUILD_ID'",
            "status": "in_progress",
            "message": "Rebuilding APK...",
            "progress": 70
          }'
    
    - name: Rebuild APK
      run: |
        apktool b decoded -o unsigned.apk
        BUILD_END_TIME=$(date +%s)
        echo "BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))" >> $GITHUB_ENV
      env:
        BUILD_START_TIME: ${{ github.event.repository.created_at }}
    
    - name: Zipalign
      run: |
        zipalign -v 4 unsigned.apk aligned.apk
    
    - name: Sign APK
      run: |
        if [ ! -f "keystore.jks" ]; then
          keytool -genkey -v -keystore keystore.jks -keyalg RSA -keysize 2048 \
            -validity 10000 -alias mykey -storepass Hossain@11223 -keypass Hossain@11223 \
            -dname "CN=Qavola, OU=Development, O=Qavola, L=City, ST=State, C=US"
        fi
        
        apksigner sign --ks keystore.jks --ks-key-alias mykey --ks-pass pass:Hossain@11223 \
          --key-pass pass:Hossain@11223 aligned.apk
        
        mv aligned.apk ${{ github.event.inputs.buildId }}.apk
    
    - name: Update build status - Uploading to S3
      run: |
        curl -X POST "$API_BASE_URL/api/build/status-update" \
          -H "Content-Type: application/json" \
          -H "X-Build-Secret: $BUILD_SECRET" \
          -d '{
            "buildId": "'$BUILD_ID'",
            "status": "in_progress",
            "message": "Uploading APK to S3...",
            "progress": 85
          }'
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
    
    - name: Upload to S3
      id: upload
      run: |
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        FILENAME="builds/$BUILD_ID/$BUILD_ID.apk"
        
        aws s3 cp $BUILD_ID.apk s3://$AWS_S3_BUCKET/$FILENAME
        
        PRESIGNED_URL=$(aws s3 presign s3://$AWS_S3_BUCKET/$FILENAME --expires-in 604800)
        
        FILE_SIZE=$(stat -c%s "$BUILD_ID.apk")
        
        echo "download_url=$PRESIGNED_URL" >> $GITHUB_OUTPUT
        echo "file_size=$FILE_SIZE" >> $GITHUB_OUTPUT
    
    - name: Update build status - Completed
      run: |
        curl -X POST "$API_BASE_URL/api/build/status-update" \
          -H "Content-Type: application/json" \
          -H "X-Build-Secret: $BUILD_SECRET" \
          -d '{
            "buildId": "'$BUILD_ID'",
            "status": "completed",
            "conclusion": "success",
            "downloadUrl": "${{ steps.upload.outputs.download_url }}",
            "fileSize": ${{ steps.upload.outputs.file_size }},
            "buildDuration": '${{ env.BUILD_DURATION }}',
            "buildCompletedAt": "'$(date -Iseconds)'",
            "message": "APK built successfully!"
          }'
    
    - name: Send email notification
      run: |
        curl -X POST "$API_BASE_URL/api/build/send-email" \
          -H "Content-Type: application/json" \
          -H "X-Build-Secret: $BUILD_SECRET" \
          -d '{
            "buildId": "'$BUILD_ID'",
            "appName": "'$APP_NAME'",
            "downloadUrl": "${{ steps.upload.outputs.download_url }}",
            "status": "success",
            "contactEmail": "'$CONTACT_EMAIL'"
          }'
    
    - name: Cleanup
      if: always()
      run: |
        rm -rf decoded unsigned.apk aligned.apk *.apk
    
    - name: Update build status - Failed
      if: failure()
      run: |
        curl -X POST "$API_BASE_URL/api/build/status-update" \
          -H "Content-Type: application/json" \
          -H "X-Build-Secret: $BUILD_SECRET" \
          -d '{
            "buildId": "'$BUILD_ID'",
            "status": "completed",
            "conclusion": "failure",
            "errorMessage": "Build failed during workflow execution",
            "message": "APK build failed"
          }'
        
        curl -X POST "$API_BASE_URL/api/build/send-email" \
          -H "Content-Type: application/json" \
          -H "X-Build-Secret: $BUILD_SECRET" \
          -d '{
            "buildId": "'$BUILD_ID'",
            "appName": "'$APP_NAME'",
            "status": "failure",
            "contactEmail": "'$CONTACT_EMAIL'"
          }'
